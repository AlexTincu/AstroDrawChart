<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Natal Chart Generator</title>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/swisseph/2.10.03/swisseph.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/swisseph@0.5.17/lib/swisseph.js"></script> -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-section {
            background: #f8fafc;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .chart-container {
            text-align: center;
            margin-top: 30px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        #natal-chart {
            border: 2px solid #e2e8f0;
            border-radius: 50%;
            background: white;
        }
        
        .error {
            background: #feb2b2;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåü Visual Natal Chart Generator üåü</h1>
        
        <div class="form-section">
            <div class="form-row">
                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" id="name" placeholder="Enter name">
                </div>
                <div class="form-group">
                    <label for="date">Date of Birth:</label>
                    <input type="date" id="date">
                </div>
                <div class="form-group">
                    <label for="time">Time of Birth:</label>
                    <input type="time" id="time">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="timezone">Timezone:</label>
                    <select id="timezone">
                        <option value="0">UTC</option>
                        <option value="-5">EST (UTC-5)</option>
                        <option value="-6">CST (UTC-6)</option>
                        <option value="-7">MST (UTC-7)</option>
                        <option value="-8">PST (UTC-8)</option>
                        <option value="1">CET (UTC+1)</option>
                        <option value="2">EET (UTC+2)</option>
                        <option value="3">EET (UTC+3)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lat">Latitude:</label>
                    <input type="number" id="lat" step="0.0001" placeholder="e.g., 40.7128">
                </div>
                <div class="form-group">
                    <label for="lon">Longitude:</label>
                    <input type="number" id="lon" step="0.0001" placeholder="e.g., -74.0060">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="house-system">House System:</label>
                    <select id="house-system">
                        <option value="placidus">Placidus</option>
                        <option value="whole">Whole Signs</option>
                    </select>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button onclick="generateChart()">Generate Chart</button>
            </div>
        </div>
        
        <div id="chart-container" class="chart-container" style="display: none;">
            <div id="chart-info"></div>
            <svg id="natal-chart" width="600" height="600" viewBox="0 0 600 600">
            </svg>
        </div>
    </div>

    <script>
        const PLANETS = {
            0: 'Sun', 1: 'Moon', 2: 'Mercury', 3: 'Venus', 4: 'Mars',
            5: 'Jupiter', 6: 'Saturn', 7: 'Uranus', 8: 'Neptune', 9: 'Pluto'
        };

        const PLANET_SYMBOLS = {
            'Sun': '‚òâ', 'Moon': '‚òΩ', 'Mercury': '‚òø', 'Venus': '‚ôÄ', 'Mars': '‚ôÇ',
            'Jupiter': '‚ôÉ', 'Saturn': '‚ôÑ', 'Uranus': '‚ôÖ', 'Neptune': '‚ôÜ', 'Pluto': '‚ôá'
        };

        const ZODIAC_SIGNS = [
            { name: 'Aries', symbol: '‚ôà', color: '#FF6B6B' },
            { name: 'Taurus', symbol: '‚ôâ', color: '#4ECDC4' },
            { name: 'Gemini', symbol: '‚ôä', color: '#45B7D1' },
            { name: 'Cancer', symbol: '‚ôã', color: '#96CEB4' },
            { name: 'Leo', symbol: '‚ôå', color: '#FECA57' },
            { name: 'Virgo', symbol: '‚ôç', color: '#FF9FF3' },
            { name: 'Libra', symbol: '‚ôé', color: '#54A0FF' },
            { name: 'Scorpio', symbol: '‚ôè', color: '#5F27CD' },
            { name: 'Sagittarius', symbol: '‚ôê', color: '#00D2D3' },
            { name: 'Capricorn', symbol: '‚ôë', color: '#FF9F43' },
            { name: 'Aquarius', symbol: '‚ôí', color: '#6C5CE7' },
            { name: 'Pisces', symbol: '‚ôì', color: '#A29BFE' }
        ];

        function julianDay(date, time, timezone) {
            const dt = new Date(date + 'T' + time);
            dt.setHours(dt.getHours() - timezone);
            
            const year = dt.getUTCFullYear();
            const month = dt.getUTCMonth() + 1;
            const day = dt.getUTCDate();
            const hour = dt.getUTCHours() + dt.getUTCMinutes()/60 + dt.getUTCSeconds()/3600;
            
            let a = Math.floor((14 - month) / 12);
            let y = year + 4800 - a;
            let m = month + 12 * a - 3;
            
            let jdn = day + Math.floor((153 * m + 2) / 5) + 365 * y + Math.floor(y / 4) - Math.floor(y / 100) + Math.floor(y / 400) - 32045;
            return jdn + (hour - 12) / 24;
        }

        function calculatePlanetPositions(jd) {
            const positions = {};
            
            try {
                for (let planetId = 0; planetId <= 9; planetId++) {
                    const result = Module.swe_calc_ut(jd, planetId, 0);
                    if (result.flag >= 0) {
                        positions[PLANETS[planetId]] = {
                            longitude: result.data[0],
                            latitude: result.data[1],
                            distance: result.data[2]
                        };
                    }
                }
            } catch (error) {
                console.error('Error calculating planet positions:', error);
            }
            
            return positions;
        }

        function calculateHouseCusps(jd, lat, lon, houseSystem) {
            const cusps = [];
            
            if (houseSystem === 'whole') {
                // Whole Signs: each house is a complete sign, starting from Ascendant sign
                try {
                    const ascResult = Module.swe_houses(jd, lat, lon, 'P'.charCodeAt(0));
                    if (ascResult.flag >= 0) {
                        const ascendant = ascResult.cusps[1]; // 1st house cusp = Ascendant
                        const ascSign = Math.floor(ascendant / 30);
                        
                        for (let i = 0; i < 12; i++) {
                            cusps.push(((ascSign + i) % 12) * 30);
                        }
                    }
                } catch (error) {
                    console.error('Error calculating whole sign houses:', error);
                    // Fallback to equal houses starting at 0¬∞
                    for (let i = 0; i < 12; i++) {
                        cusps.push(i * 30);
                    }
                }
            } else {
                // Placidus
                try {
                    const result = Module.swe_houses(jd, lat, lon, 'P'.charCodeAt(0));
                    if (result.flag >= 0) {
                        for (let i = 1; i <= 12; i++) {
                            cusps.push(result.cusps[i]);
                        }
                    }
                } catch (error) {
                    console.error('Error calculating Placidus houses:', error);
                    // Fallback to equal houses
                    for (let i = 0; i < 12; i++) {
                        cusps.push(i * 30);
                    }
                }
            }
            
            return cusps;
        }

        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerY + (radius * Math.sin(angleInRadians))
            };
        }

        function createSVGElement(tag, attributes = {}) {
            const element = document.createElementNS('http://www.w3.org/2000/svg', tag);
            Object.keys(attributes).forEach(key => {
                element.setAttribute(key, attributes[key]);
            });
            return element;
        }

        function drawChart(planets, houseCusps, name) {
            const svg = document.getElementById('natal-chart');
            svg.innerHTML = '';
            
            const centerX = 300;
            const centerY = 300;
            const outerRadius = 280;
            const zodiacRadius = 240;
            const houseRadius = 200;
            const planetRadius = 160;
            
            // Background circle
            svg.appendChild(createSVGElement('circle', {
                cx: centerX,
                cy: centerY,
                r: outerRadius,
                fill: '#f8fafc',
                stroke: '#2d3748',
                'stroke-width': 2
            }));
            
            // Draw zodiac signs
            for (let i = 0; i < 12; i++) {
                const startAngle = i * 30;
                const endAngle = (i + 1) * 30;
                
                // Zodiac section background
                const startPoint = polarToCartesian(centerX, centerY, outerRadius, startAngle);
                const endPoint = polarToCartesian(centerX, centerY, outerRadius, endAngle);
                const startInner = polarToCartesian(centerX, centerY, zodiacRadius, startAngle);
                const endInner = polarToCartesian(centerX, centerY, zodiacRadius, endAngle);
                
                const path = createSVGElement('path', {
                    d: `M ${centerX} ${centerY} L ${startPoint.x} ${startPoint.y} A ${outerRadius} ${outerRadius} 0 0 1 ${endPoint.x} ${endPoint.y} Z`,
                    fill: ZODIAC_SIGNS[i].color,
                    opacity: 0.1,
                    stroke: '#2d3748',
                    'stroke-width': 1
                });
                svg.appendChild(path);
                
                // Zodiac sign symbol
                const symbolAngle = startAngle + 15;
                const symbolPos = polarToCartesian(centerX, centerY, zodiacRadius + 20, symbolAngle);
                svg.appendChild(createSVGElement('text', {
                    x: symbolPos.x,
                    y: symbolPos.y,
                    'text-anchor': 'middle',
                    'dominant-baseline': 'central',
                    'font-size': '20',
                    'font-weight': 'bold',
                    fill: ZODIAC_SIGNS[i].color
                })).textContent = ZODIAC_SIGNS[i].symbol;
            }
            
            // Draw house divisions
            svg.appendChild(createSVGElement('circle', {
                cx: centerX,
                cy: centerY,
                r: houseRadius,
                fill: 'none',
                stroke: '#4a5568',
                'stroke-width': 2
            }));
            
            for (let i = 0; i < 12; i++) {
                const angle = houseCusps[i];
                const outerPoint = polarToCartesian(centerX, centerY, zodiacRadius, angle);
                const innerPoint = polarToCartesian(centerX, centerY, houseRadius, angle);
                
                // House cusp line
                svg.appendChild(createSVGElement('line', {
                    x1: outerPoint.x,
                    y1: outerPoint.y,
                    x2: innerPoint.x,
                    y2: innerPoint.y,
                    stroke: '#4a5568',
                    'stroke-width': 1
                }));
                
                // House number
                const houseNumAngle = i === 11 ? (houseCusps[i] + houseCusps[0] + 360) / 2 : (houseCusps[i] + houseCusps[i + 1]) / 2;
                const adjustedAngle = houseNumAngle > 360 ? houseNumAngle - 360 : houseNumAngle;
                const housePos = polarToCartesian(centerX, centerY, houseRadius - 20, adjustedAngle);
                
                svg.appendChild(createSVGElement('text', {
                    x: housePos.x,
                    y: housePos.y,
                    'text-anchor': 'middle',
                    'dominant-baseline': 'central',
                    'font-size': '14',
                    'font-weight': 'bold',
                    fill: '#4a5568'
                })).textContent = (i + 1).toString();
            }
            
            // Draw planets
            Object.keys(planets).forEach(planetName => {
                const planet = planets[planetName];
                const angle = planet.longitude;
                const pos = polarToCartesian(centerX, centerY, planetRadius, angle);
                
                // Planet symbol
                svg.appendChild(createSVGElement('text', {
                    x: pos.x,
                    y: pos.y,
                    'text-anchor': 'middle',
                    'dominant-baseline': 'central',
                    'font-size': '18',
                    'font-weight': 'bold',
                    fill: '#2d3748'
                })).textContent = PLANET_SYMBOLS[planetName];
                
                // Planet degree (small text)
                const degreePos = polarToCartesian(centerX, centerY, planetRadius - 25, angle);
                const degrees = Math.floor(planet.longitude % 30);
                const minutes = Math.floor((planet.longitude % 1) * 60);
                
                svg.appendChild(createSVGElement('text', {
                    x: degreePos.x,
                    y: degreePos.y,
                    'text-anchor': 'middle',
                    'dominant-baseline': 'central',
                    'font-size': '10',
                    fill: '#666'
                })).textContent = `${degrees}¬∞${minutes}'`;
            });
            
            // Center circle
            svg.appendChild(createSVGElement('circle', {
                cx: centerX,
                cy: centerY,
                r: 50,
                fill: 'white',
                stroke: '#4a5568',
                'stroke-width': 2
            }));
            
            // Chart info
            const chartInfo = document.getElementById('chart-info');
            chartInfo.innerHTML = `<h3>${name || 'Natal Chart'}</h3>`;
        }

        async function generateChart() {
            const name = document.getElementById('name').value;
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const timezone = parseFloat(document.getElementById('timezone').value);
            const lat = parseFloat(document.getElementById('lat').value);
            const lon = parseFloat(document.getElementById('lon').value);
            const houseSystem = document.getElementById('house-system').value;
            
            if (!date || !time || isNaN(lat) || isNaN(lon)) {
                alert('Please fill in all required fields.');
                return;
            }
            
            const chartContainer = document.getElementById('chart-container');
            const chartInfo = document.getElementById('chart-info');
            chartInfo.innerHTML = '<div class="loading">Generating chart...</div>';
            chartContainer.style.display = 'block';
            
            try {
                // Wait for Swiss Ephemeris to load
                // await waitForSwissEphemeris();
                
                // const jd = julianDay(date, time, timezone);
                // const planets = calculatePlanetPositions(jd);
                // const houseCusps = calculateHouseCusps(jd, lat, lon, houseSystem);

                // fetch instead
                const { planets, houses:houseCusps } = await fetchChartData(date, lat, lon, timezone, houseSystem);
                
                console.log(planets);
                console.log(houseCusps.houses);                

                drawChart(planets, houseCusps.houses, name);
                
            } catch (error) {
                console.error('Chart generation error:', error);
                chartInfo.innerHTML = `<div class="error">Error generating chart: ${error.message}</div>`;
            }
        }

        async function fetchChartData(date, latitude, longitude, timezone, houseSystem) 
        {
            const res = await fetch('http://localhost:3000/natal', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, latitude, longitude, timezone, houseSystem })
            });
            if (!res.ok) throw new Error(`API error: ${res.status}`);
            return res.json(); // expecting { planets: {...}, houseCusps: [...] }
        }

        function waitForSwissEphemeris() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 100; // 10 seconds timeout
                
                function checkModule() {
                    attempts++;
                    
                    if (typeof Module !== 'undefined' && Module.swe_calc_ut && Module.swe_houses) {
                        resolve();
                        return;
                    }
                    
                    if (attempts >= maxAttempts) {
                        reject(new Error('Swiss Ephemeris failed to load after 10 seconds'));
                        return;
                    }
                    
                    setTimeout(checkModule, 100);
                }
                
                checkModule();
            });
        }

        // Set default values
        window.addEventListener('load', () => {
            document.getElementById('date').value = '1985-11-06';
            document.getElementById('time').value = '19:35';
            document.getElementById('lat').value = '44.4';
            document.getElementById('lon').value = '26.1';
            document.getElementById('timezone').value = '2';
            document.getElementById('name').value = 'Alex Solara';
        });
    </script>
</body>
</html>